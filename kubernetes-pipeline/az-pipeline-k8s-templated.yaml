# ==========================================
# AZURE DEVOPS KUBERNETES PIPELINE (TEMPLATED)
# Uses reusable templates for tools & credentials
# ==========================================

name: $(Date:yyyyMMdd)$(Rev:.r)-k8s-templated

# -----------------------
# TRIGGERS
# -----------------------
trigger:
  branches:
    include:
      - main
      - releases/*
  paths:
    include:
      - k8s/*
      - helm/*
      - src/*
    exclude:
      - docs/*

pr:
  branches:
    include:
      - main
      - develop

# -----------------------
# RESOURCES
# -----------------------
resources:
  repositories:
    - repository: templates
      type: git
      name: MyProject/pipeline-templates  # Or use self for same repo
      ref: refs/heads/main

# -----------------------
# PARAMETERS
# -----------------------
parameters:
  - name: environment
    type: string
    default: dev
    values: [dev, staging, prod]

  - name: kubernetesCluster
    type: string
    default: aks-dev-cluster
    displayName: "Target Kubernetes Cluster"

  - name: namespace
    type: string
    default: default
    displayName: "Target Namespace"

  - name: deploymentStrategy
    type: string
    default: helm
    values: [kubectl, helm, kustomize]
    displayName: "Deployment Strategy"

  - name: helmReleaseName
    type: string
    default: myapp
    displayName: "Helm Release Name"

  - name: helmChartPath
    type: string
    default: charts/myapp
    displayName: "Helm Chart Path"

  - name: kubectlManifestPath
    type: string
    default: k8s/manifests
    displayName: "Kubectl Manifests Path"

  - name: imageTag
    type: string
    default: latest
    displayName: "Container Image Tag"

  - name: runTests
    type: boolean
    default: true

  - name: dryRun
    type: boolean
    default: false
    displayName: "Dry Run (no actual deployment)"

  # Credential connection type
  - name: credentialType
    type: string
    default: serviceConnection
    values: [serviceConnection, aks]
    displayName: "K8s Credential Type"

# -----------------------
# VARIABLES
# -----------------------
variables:
  vmImage: ubuntu-latest
  kubectlVersion: '1.31.0'
  helmVersion: '3.16.3'

  # Variable groups
  - group: k8s-secrets

  # Environment-specific variables
  - template: variables/vars-${{ parameters.environment }}.yaml

# ==========================================
# STAGES
# ==========================================
stages:

  # ------------------------------------------
  # STAGE 1: PREP / INSTALL TOOLS
  # ------------------------------------------
  - stage: Prep
    displayName: "Prep & Install Tools"
    jobs:
      - job: install_tools
        displayName: "Install K8s Tools"
        pool:
          vmImage: $(vmImage)

        steps:
          - checkout: self
            displayName: "Checkout self"
            fetchDepth: 0

          # ========================================
          # USE TEMPLATE: Install K8s Tools
          # ========================================
          - template: templates/install-k8s-tools.yaml
            parameters:
              kubectlVersion: $(kubectlVersion)
              helmVersion: $(helmVersion)
              installKustomize: ${{ eq(parameters.deploymentStrategy, 'kustomize') }}
              installKubeseal: false
              installK9s: false
              useAzureDevOpsTasks: true

          # Set output variables
          - bash: |
              echo "##vso[task.setvariable variable=gitSha;isOutput=true]$(Build.SourceVersion)"
              echo "##vso[task.setvariable variable=gitShort;isOutput=true]$(echo $(Build.SourceVersion) | cut -c1-7)"
              echo "##vso[task.setvariable variable=buildId;isOutput=true]$(Build.BuildId)"
            name: setvars
            displayName: "Set output vars"

  # ------------------------------------------
  # STAGE 2: BUILD & PUSH CONTAINER IMAGE
  # ------------------------------------------
  - stage: Build
    displayName: "Build Container Image"
    dependsOn: Prep
    variables:
      gitShort: $[ stageDependencies.Prep.install_tools.outputs['setvars.gitShort'] ]
    jobs:
      - job: build_image
        displayName: "Build & Push Image"
        pool:
          vmImage: $(vmImage)

        steps:
          - checkout: self

          - task: Docker@2
            displayName: "Login to ACR"
            inputs:
              command: login
              containerRegistry: $(containerRegistryServiceConnection)

          - task: Docker@2
            displayName: "Build and Push"
            inputs:
              command: buildAndPush
              repository: $(containerRepository)
              dockerfile: $(Build.SourcesDirectory)/Dockerfile
              containerRegistry: $(containerRegistryServiceConnection)
              tags: |
                $(gitShort)
                ${{ parameters.imageTag }}
                $(Build.BuildId)

          - publish: $(Build.SourcesDirectory)/${{ parameters.kubectlManifestPath }}
            artifact: k8s-manifests
            displayName: "Publish K8s manifests"
            condition: eq('${{ parameters.deploymentStrategy }}', 'kubectl')

          - publish: $(Build.SourcesDirectory)/${{ parameters.helmChartPath }}
            artifact: helm-chart
            displayName: "Publish Helm chart"
            condition: eq('${{ parameters.deploymentStrategy }}', 'helm')

  # ------------------------------------------
  # STAGE 3: VALIDATE
  # ------------------------------------------
  - stage: Validate
    displayName: "Validate K8s Resources"
    dependsOn: Build
    condition: and(succeeded(), eq('${{ parameters.runTests }}', true))
    jobs:
      - job: validate_manifests
        displayName: "Validate Manifests"
        pool:
          vmImage: $(vmImage)

        steps:
          - checkout: self

          # ========================================
          # USE TEMPLATE: Install K8s Tools
          # ========================================
          - template: templates/install-k8s-tools.yaml
            parameters:
              kubectlVersion: $(kubectlVersion)
              helmVersion: $(helmVersion)
              installKustomize: ${{ eq(parameters.deploymentStrategy, 'kustomize') }}

          # Kubectl validation
          - bash: |
              echo "Validating Kubernetes manifests..."
              for file in $(find ${{ parameters.kubectlManifestPath }} -name '*.yaml' -o -name '*.yml'); do
                echo "Validating: $file"
                kubectl apply --dry-run=client -f "$file" || exit 1
              done
              echo "All manifests are valid!"
            displayName: "kubectl dry-run validation"
            condition: eq('${{ parameters.deploymentStrategy }}', 'kubectl')

          # Helm validation
          - bash: |
              echo "Linting Helm chart..."
              helm lint ${{ parameters.helmChartPath }}
              
              echo "Template validation..."
              helm template ${{ parameters.helmReleaseName }} ${{ parameters.helmChartPath }} \
                --namespace ${{ parameters.namespace }} \
                --set image.tag=${{ parameters.imageTag }} \
                > /tmp/rendered.yaml
              
              echo "Validating rendered templates..."
              kubectl apply --dry-run=client -f /tmp/rendered.yaml
            displayName: "Helm lint & template validation"
            condition: eq('${{ parameters.deploymentStrategy }}', 'helm')

          # Kustomize validation
          - bash: |
              echo "Building kustomize overlay..."
              kustomize build ${{ parameters.kubectlManifestPath }}/overlays/${{ parameters.environment }} > /tmp/kustomize-output.yaml
              
              echo "Validating kustomize output..."
              kubectl apply --dry-run=client -f /tmp/kustomize-output.yaml
            displayName: "Kustomize build & validation"
            condition: eq('${{ parameters.deploymentStrategy }}', 'kustomize')

  # ------------------------------------------
  # STAGE 4: DEPLOY TO KUBERNETES
  # ------------------------------------------
  - stage: Deploy
    displayName: "Deploy to Kubernetes"
    dependsOn: Validate
    condition: and(succeeded(), eq('${{ parameters.dryRun }}', false))
    jobs:
      - deployment: deploy_k8s
        displayName: "Deploy to ${{ parameters.environment }}"
        environment: ${{ parameters.environment }}-k8s.${{ parameters.namespace }}
        pool:
          vmImage: $(vmImage)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                # ========================================
                # USE TEMPLATE: Install K8s Tools
                # ========================================
                - template: templates/install-k8s-tools.yaml
                  parameters:
                    kubectlVersion: $(kubectlVersion)
                    helmVersion: $(helmVersion)
                    installKustomize: ${{ eq(parameters.deploymentStrategy, 'kustomize') }}

                # ========================================
                # USE TEMPLATE: Get K8s Credentials
                # ========================================
                # Option A: Service Connection
                - ${{ if eq(parameters.credentialType, 'serviceConnection') }}:
                  - template: templates/get-k8s-credentials.yaml
                    parameters:
                      connectionType: serviceConnection
                      kubernetesServiceConnection: $(kubernetesServiceConnection)
                      namespace: ${{ parameters.namespace }}
                      verifyConnection: true

                # Option B: AKS
                - ${{ if eq(parameters.credentialType, 'aks') }}:
                  - template: templates/get-k8s-credentials.yaml
                    parameters:
                      connectionType: aks
                      azureServiceConnection: $(azureServiceConnection)
                      aksResourceGroup: $(aksResourceGroup)
                      aksClusterName: ${{ parameters.kubernetesCluster }}
                      aksAdmin: false
                      namespace: ${{ parameters.namespace }}
                      verifyConnection: true

                # Create namespace
                - task: Kubernetes@1
                  displayName: "Create namespace if not exists"
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    command: 'apply'
                    useConfigurationFile: false
                    inline: |
                      apiVersion: v1
                      kind: Namespace
                      metadata:
                        name: ${{ parameters.namespace }}
                        labels:
                          environment: ${{ parameters.environment }}
                  condition: eq('${{ parameters.credentialType }}', 'serviceConnection')

                # Deploy: kubectl
                - task: KubernetesManifest@1
                  displayName: "Deploy manifests (kubectl)"
                  condition: eq('${{ parameters.deploymentStrategy }}', 'kubectl')
                  inputs:
                    action: 'deploy'
                    connectionType: 'kubernetesServiceConnection'
                    kubernetesServiceConnection: $(kubernetesServiceConnection)
                    namespace: ${{ parameters.namespace }}
                    manifests: |
                      $(Build.SourcesDirectory)/${{ parameters.kubectlManifestPath }}/*.yaml
                    containers: |
                      $(containerRegistry)/$(containerRepository):${{ parameters.imageTag }}

                # Deploy: Helm
                - task: HelmDeploy@1
                  displayName: "Deploy Helm chart"
                  condition: eq('${{ parameters.deploymentStrategy }}', 'helm')
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: ${{ parameters.namespace }}
                    command: 'upgrade'
                    chartType: 'FilePath'
                    chartPath: $(Build.SourcesDirectory)/${{ parameters.helmChartPath }}
                    releaseName: ${{ parameters.helmReleaseName }}
                    install: true
                    waitForExecution: true
                    arguments: >
                      --set image.repository=$(containerRegistry)/$(containerRepository)
                      --set image.tag=${{ parameters.imageTag }}
                      --set environment=${{ parameters.environment }}
                      --timeout 10m0s
                      --atomic

                # Deploy: Kustomize
                - bash: |
                    echo "Applying kustomize overlay for ${{ parameters.environment }}..."
                    kustomize build ${{ parameters.kubectlManifestPath }}/overlays/${{ parameters.environment }} | kubectl apply -f -
                  displayName: "Deploy with Kustomize"
                  condition: eq('${{ parameters.deploymentStrategy }}', 'kustomize')

  # ------------------------------------------
  # STAGE 5: VERIFY DEPLOYMENT
  # ------------------------------------------
  - stage: Verify
    displayName: "Verify Deployment"
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: verify_deployment
        displayName: "Verify K8s Deployment"
        pool:
          vmImage: $(vmImage)

        steps:
          # ========================================
          # USE TEMPLATE: Install K8s Tools
          # ========================================
          - template: templates/install-k8s-tools.yaml
            parameters:
              kubectlVersion: $(kubectlVersion)
              helmVersion: $(helmVersion)

          # ========================================
          # USE TEMPLATE: Get K8s Credentials
          # ========================================
          - ${{ if eq(parameters.credentialType, 'serviceConnection') }}:
            - template: templates/get-k8s-credentials.yaml
              parameters:
                connectionType: serviceConnection
                kubernetesServiceConnection: $(kubernetesServiceConnection)
                namespace: ${{ parameters.namespace }}

          - ${{ if eq(parameters.credentialType, 'aks') }}:
            - template: templates/get-k8s-credentials.yaml
              parameters:
                connectionType: aks
                azureServiceConnection: $(azureServiceConnection)
                aksResourceGroup: $(aksResourceGroup)
                aksClusterName: ${{ parameters.kubernetesCluster }}
                namespace: ${{ parameters.namespace }}

          # Check rollout status
          - task: Kubernetes@1
            displayName: "Check rollout status"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(kubernetesServiceConnection)
              namespace: ${{ parameters.namespace }}
              command: 'rollout'
              arguments: 'status deployment/${{ parameters.helmReleaseName }} --timeout=300s'

          # Get deployment info
          - task: Kubernetes@1
            displayName: "Get deployment details"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(kubernetesServiceConnection)
              namespace: ${{ parameters.namespace }}
              command: 'get'
              arguments: 'deployments,pods,services -l app=${{ parameters.helmReleaseName }} -o wide'

          # Health check
          - bash: |
              echo "Waiting for pods to be ready..."
              sleep 30
              
              SERVICE_IP=$(kubectl get svc ${{ parameters.helmReleaseName }} -n ${{ parameters.namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
              
              if [ -n "$SERVICE_IP" ]; then
                echo "Service IP: $SERVICE_IP"
              else
                echo "Service is ClusterIP or LoadBalancer IP not yet assigned"
              fi
              
              echo "Deployment verification complete!"
            displayName: "Basic health check"

          # Get events
          - task: Kubernetes@1
            displayName: "Get recent events"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(kubernetesServiceConnection)
              namespace: ${{ parameters.namespace }}
              command: 'get'
              arguments: 'events --sort-by=.lastTimestamp | tail -20'
            condition: always()

  # ------------------------------------------
  # STAGE 6: POST DEPLOYMENT
  # ------------------------------------------
  - stage: Post
    displayName: "Post Deployment"
    dependsOn:
      - Verify
    condition: always()
    jobs:
      - job: notify
        displayName: "Notify & Cleanup"
        pool:
          vmImage: $(vmImage)

        steps:
          - bash: |
              echo "=========================================="
              echo "DEPLOYMENT SUMMARY"
              echo "=========================================="
              echo "Environment: ${{ parameters.environment }}"
              echo "Cluster: ${{ parameters.kubernetesCluster }}"
              echo "Namespace: ${{ parameters.namespace }}"
              echo "Strategy: ${{ parameters.deploymentStrategy }}"
              echo "Image Tag: ${{ parameters.imageTag }}"
              echo "Credential Type: ${{ parameters.credentialType }}"
              echo "Pipeline Status: $(Agent.JobStatus)"
              echo "Build ID: $(Build.BuildId)"
              echo "=========================================="
            displayName: "Deployment Summary"

  # ------------------------------------------
  # STAGE 7: ROLLBACK (manual trigger only)
  # ------------------------------------------
  - stage: Rollback
    displayName: "Rollback (Manual)"
    dependsOn: []
    condition: eq(variables['triggerRollback'], 'true')
    jobs:
      - deployment: rollback_k8s
        displayName: "Rollback Deployment"
        environment: ${{ parameters.environment }}-k8s.${{ parameters.namespace }}
        pool:
          vmImage: $(vmImage)
        strategy:
          runOnce:
            deploy:
              steps:
                # ========================================
                # USE TEMPLATE: Install K8s Tools
                # ========================================
                - template: templates/install-k8s-tools.yaml
                  parameters:
                    kubectlVersion: $(kubectlVersion)
                    helmVersion: $(helmVersion)

                # ========================================
                # USE TEMPLATE: Get K8s Credentials
                # ========================================
                - ${{ if eq(parameters.credentialType, 'serviceConnection') }}:
                  - template: templates/get-k8s-credentials.yaml
                    parameters:
                      connectionType: serviceConnection
                      kubernetesServiceConnection: $(kubernetesServiceConnection)
                      namespace: ${{ parameters.namespace }}

                - ${{ if eq(parameters.credentialType, 'aks') }}:
                  - template: templates/get-k8s-credentials.yaml
                    parameters:
                      connectionType: aks
                      azureServiceConnection: $(azureServiceConnection)
                      aksResourceGroup: $(aksResourceGroup)
                      aksClusterName: ${{ parameters.kubernetesCluster }}
                      namespace: ${{ parameters.namespace }}

                # Kubectl rollback
                - task: Kubernetes@1
                  displayName: "Rollback deployment (kubectl)"
                  condition: eq('${{ parameters.deploymentStrategy }}', 'kubectl')
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: ${{ parameters.namespace }}
                    command: 'rollout'
                    arguments: 'undo deployment/${{ parameters.helmReleaseName }}'

                # Helm rollback
                - task: HelmDeploy@1
                  displayName: "Rollback Helm release"
                  condition: eq('${{ parameters.deploymentStrategy }}', 'helm')
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: ${{ parameters.namespace }}
                    command: 'rollback'
                    arguments: '${{ parameters.helmReleaseName }} 0'

                - bash: |
                    echo "Rollback initiated for ${{ parameters.helmReleaseName }}"
                    echo "Checking rollout status..."
                  displayName: "Rollback complete"

