# ==========================================
# TEMPLATE: Install Kubernetes Tools
# ==========================================
# Usage:
#   - template: templates/install-k8s-tools.yaml
#     parameters:
#       kubectlVersion: '1.31.0'
#       helmVersion: '3.16.3'
# ==========================================

parameters:
  # Tool versions
  - name: kubectlVersion
    type: string
    default: '1.31.0'

  - name: helmVersion
    type: string
    default: '3.16.3'

  # Control whether to use Azure DevOps tasks or manual install
  - name: useAzureDevOpsTasks
    type: boolean
    default: true

  # Install Azure CLI
  - name: installAzureCLI
    type: boolean
    default: true

steps:
  # ----------------------------
  # INSTALL AZURE CLI
  # ----------------------------
  - ${{ if eq(parameters.installAzureCLI, true) }}:
    - script: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az version
      displayName: "Install Azure CLI"

  # ----------------------------
  # INSTALL KUBECTL
  # ----------------------------
  - ${{ if eq(parameters.useAzureDevOpsTasks, true) }}:
    - task: KubectlInstaller@0
      displayName: "Install kubectl ${{ parameters.kubectlVersion }}"
      inputs:
        kubectlVersion: ${{ parameters.kubectlVersion }}

  - ${{ if eq(parameters.useAzureDevOpsTasks, false) }}:
    - bash: |
        echo "Installing kubectl ${{ parameters.kubectlVersion }}..."
        KUBECTL_VERSION="v${{ parameters.kubectlVersion }}"
        curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
        curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl.sha256"
        echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        rm -f kubectl.sha256
      displayName: "Install kubectl ${{ parameters.kubectlVersion }} (manual)"

  - bash: |
      echo "Verifying kubectl installation..."
      kubectl version --client --output=yaml
    displayName: "Verify kubectl"

  # ----------------------------
  # INSTALL HELM
  # ----------------------------
  - ${{ if eq(parameters.useAzureDevOpsTasks, true) }}:
    - task: HelmInstaller@1
      displayName: "Install Helm ${{ parameters.helmVersion }}"
      inputs:
        helmVersionToInstall: ${{ parameters.helmVersion }}

  - ${{ if eq(parameters.useAzureDevOpsTasks, false) }}:
    - bash: |
        echo "Installing Helm ${{ parameters.helmVersion }}..."
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh --version v${{ parameters.helmVersion }}
        rm -f get_helm.sh
      displayName: "Install Helm ${{ parameters.helmVersion }} (manual)"

  - bash: |
      echo "Verifying Helm installation..."
      helm version
    displayName: "Verify Helm"

  # ----------------------------
  # SUMMARY
  # ----------------------------
  - bash: |
      echo "=========================================="
      echo "K8S TOOLS INSTALLATION SUMMARY"
      echo "=========================================="
      if command -v az &> /dev/null; then
        echo "az cli: $(az version --query '"azure-cli"' -o tsv)"
      fi
      echo "kubectl: $(kubectl version --client --short 2>/dev/null || kubectl version --client -o yaml | grep gitVersion | head -1)"
      echo "helm: $(helm version --short)"
      echo "=========================================="
    displayName: "Tools installation summary"

