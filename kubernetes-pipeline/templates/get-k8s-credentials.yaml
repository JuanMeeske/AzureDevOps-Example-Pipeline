# ==========================================
# TEMPLATE: Get Kubernetes Credentials
# ==========================================
# Usage:
#   - template: templates/get-k8s-credentials.yaml
#     parameters:
#       connectionType: 'serviceConnection'  # or 'aks' or 'kubeconfig'
#       kubernetesServiceConnection: 'my-k8s-connection'
#       shellType: 'bash'  # or 'pwsh'
# ==========================================

parameters:
  # Connection type: 'serviceConnection', 'aks', 'kubeconfig', 'gke', 'eks'
  - name: connectionType
    type: string
    default: 'serviceConnection'
    values:
      - serviceConnection
      - aks
      - kubeconfig
      - gke
      - eks

  # For Service Connection type
  - name: kubernetesServiceConnection
    type: string
    default: ''

  # For AKS type
  - name: azureServiceConnection
    type: string
    default: ''

  - name: aksResourceGroup
    type: string
    default: ''

  - name: aksClusterName
    type: string
    default: ''

  - name: aksAdmin
    type: boolean
    default: false

  # For GKE type
  - name: gcpServiceConnection
    type: string
    default: ''

  - name: gkeProject
    type: string
    default: ''

  - name: gkeCluster
    type: string
    default: ''

  - name: gkeZone
    type: string
    default: ''

  # For EKS type
  - name: awsServiceConnection
    type: string
    default: ''

  - name: eksClusterName
    type: string
    default: ''

  - name: awsRegion
    type: string
    default: 'us-east-1'

  # For kubeconfig type
  - name: kubeconfigVariable
    type: string
    default: 'KUBECONFIG_CONTENT'

  # Common parameters
  - name: namespace
    type: string
    default: 'default'

  - name: verifyConnection
    type: boolean
    default: true

  # Shell type: 'bash' or 'pwsh'
  - name: shellType
    type: string
    default: 'bash'
    values:
      - bash
      - pwsh

steps:
  # ----------------------------
  # OPTION 1: KUBERNETES SERVICE CONNECTION
  # ----------------------------
  - ${{ if eq(parameters.connectionType, 'serviceConnection') }}:
    - task: Kubernetes@1
      displayName: "Connect via Service Connection"
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceEndpoint: ${{ parameters.kubernetesServiceConnection }}
        command: 'get'
        arguments: 'nodes'
        outputFormat: 'wide'

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - task: Kubernetes@1
        displayName: "Verify cluster access"
        inputs:
          connectionType: 'Kubernetes Service Connection'
          kubernetesServiceEndpoint: ${{ parameters.kubernetesServiceConnection }}
          namespace: ${{ parameters.namespace }}
          command: 'get'
          arguments: 'namespaces'

  # ----------------------------
  # OPTION 2: AZURE AKS (bash)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'aks'), eq(parameters.shellType, 'bash')) }}:
    - task: AzureCLI@2
      displayName: "Get AKS credentials"
      inputs:
        azureSubscription: ${{ parameters.azureServiceConnection }}
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Fetching AKS credentials..."
          echo "Resource Group: ${{ parameters.aksResourceGroup }}"
          echo "Cluster Name: ${{ parameters.aksClusterName }}"
          
          # Get credentials
          az aks get-credentials \
            --resource-group "${{ parameters.aksResourceGroup }}" \
            --name "${{ parameters.aksClusterName }}" \
            ${{ if eq(parameters.aksAdmin, true) }}:
              --admin \
            --overwrite-existing
          
          # Display current context
          echo "Current context:"
          kubectl config current-context
          
          # Verify connection
          echo "Cluster nodes:"
          kubectl get nodes -o wide

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - bash: |
          echo "Verifying AKS cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          echo "Cluster access verified!"
        displayName: "Verify AKS cluster access"

  # ----------------------------
  # OPTION 2: AZURE AKS (PowerShell)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'aks'), eq(parameters.shellType, 'pwsh')) }}:
    - task: AzureCLI@2
      displayName: "Get AKS credentials"
      inputs:
        azureSubscription: ${{ parameters.azureServiceConnection }}
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: |
          Write-Host "Fetching AKS credentials..."
          Write-Host "Resource Group: ${{ parameters.aksResourceGroup }}"
          Write-Host "Cluster Name: ${{ parameters.aksClusterName }}"
          
          # Get credentials
          $adminFlag = ""
          if ("${{ parameters.aksAdmin }}" -eq "true") {
              $adminFlag = "--admin"
          }
          
          az aks get-credentials `
            --resource-group "${{ parameters.aksResourceGroup }}" `
            --name "${{ parameters.aksClusterName }}" `
            $adminFlag `
            --overwrite-existing
          
          # Display current context
          Write-Host "Current context:"
          kubectl config current-context
          
          # Verify connection
          Write-Host "Cluster nodes:"
          kubectl get nodes -o wide

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - pwsh: |
          Write-Host "Verifying AKS cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          Write-Host "Cluster access verified!"
        displayName: "Verify AKS cluster access"

  # ----------------------------
  # OPTION 3: KUBECONFIG VARIABLE (bash)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'kubeconfig'), eq(parameters.shellType, 'bash')) }}:
    - bash: |
        echo "Setting up kubeconfig from variable..."
        mkdir -p ~/.kube
        echo "$(${{ parameters.kubeconfigVariable }})" > ~/.kube/config
        chmod 600 ~/.kube/config
        
        echo "Current context:"
        kubectl config current-context
        
        echo "Cluster nodes:"
        kubectl get nodes -o wide
      displayName: "Setup kubeconfig from variable"
      env:
        ${{ parameters.kubeconfigVariable }}: $(${{ parameters.kubeconfigVariable }})

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - bash: |
          echo "Verifying cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          echo "Cluster access verified!"
        displayName: "Verify cluster access (kubeconfig)"

  # ----------------------------
  # OPTION 3: KUBECONFIG VARIABLE (PowerShell)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'kubeconfig'), eq(parameters.shellType, 'pwsh')) }}:
    - pwsh: |
        Write-Host "Setting up kubeconfig from variable..."
        $kubeDir = "$env:USERPROFILE\.kube"
        New-Item -ItemType Directory -Force -Path $kubeDir | Out-Null
        $env:${{ parameters.kubeconfigVariable }} | Out-File -FilePath "$kubeDir\config" -Encoding utf8
        
        Write-Host "Current context:"
        kubectl config current-context
        
        Write-Host "Cluster nodes:"
        kubectl get nodes -o wide
      displayName: "Setup kubeconfig from variable"
      env:
        ${{ parameters.kubeconfigVariable }}: $(${{ parameters.kubeconfigVariable }})

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - pwsh: |
          Write-Host "Verifying cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          Write-Host "Cluster access verified!"
        displayName: "Verify cluster access (kubeconfig)"

  # ----------------------------
  # OPTION 4: GOOGLE GKE (bash)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'gke'), eq(parameters.shellType, 'bash')) }}:
    - task: GoogleCloudSdkTool@0
      displayName: "Setup gcloud SDK"
      inputs:
        version: 'latest'

    - bash: |
        echo "Authenticating to GKE..."
        gcloud container clusters get-credentials "${{ parameters.gkeCluster }}" \
          --project "${{ parameters.gkeProject }}" \
          --zone "${{ parameters.gkeZone }}"
        
        echo "Current context:"
        kubectl config current-context
        
        echo "Cluster nodes:"
        kubectl get nodes -o wide
      displayName: "Get GKE credentials"

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - bash: |
          echo "Verifying GKE cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          echo "Cluster access verified!"
        displayName: "Verify GKE cluster access"

  # ----------------------------
  # OPTION 4: GOOGLE GKE (PowerShell)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'gke'), eq(parameters.shellType, 'pwsh')) }}:
    - task: GoogleCloudSdkTool@0
      displayName: "Setup gcloud SDK"
      inputs:
        version: 'latest'

    - pwsh: |
        Write-Host "Authenticating to GKE..."
        gcloud container clusters get-credentials "${{ parameters.gkeCluster }}" `
          --project "${{ parameters.gkeProject }}" `
          --zone "${{ parameters.gkeZone }}"
        
        Write-Host "Current context:"
        kubectl config current-context
        
        Write-Host "Cluster nodes:"
        kubectl get nodes -o wide
      displayName: "Get GKE credentials"

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - pwsh: |
          Write-Host "Verifying GKE cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          Write-Host "Cluster access verified!"
        displayName: "Verify GKE cluster access"

  # ----------------------------
  # OPTION 5: AWS EKS (bash)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'eks'), eq(parameters.shellType, 'bash')) }}:
    - task: AmazonWebServices.aws-vsts-tools.AWSShellScript.AWSShellScript@1
      displayName: "Get EKS credentials"
      inputs:
        awsCredentials: ${{ parameters.awsServiceConnection }}
        regionName: ${{ parameters.awsRegion }}
        scriptType: inline
        inlineScript: |
          echo "Updating kubeconfig for EKS cluster..."
          aws eks update-kubeconfig \
            --name "${{ parameters.eksClusterName }}" \
            --region "${{ parameters.awsRegion }}"
          
          echo "Current context:"
          kubectl config current-context
          
          echo "Cluster nodes:"
          kubectl get nodes -o wide

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - bash: |
          echo "Verifying EKS cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          echo "Cluster access verified!"
        displayName: "Verify EKS cluster access"

  # ----------------------------
  # OPTION 5: AWS EKS (PowerShell)
  # ----------------------------
  - ${{ if and(eq(parameters.connectionType, 'eks'), eq(parameters.shellType, 'pwsh')) }}:
    - task: AmazonWebServices.aws-vsts-tools.AWSPowerShellModuleScript.AWSPowerShellModuleScript@1
      displayName: "Get EKS credentials"
      inputs:
        awsCredentials: ${{ parameters.awsServiceConnection }}
        regionName: ${{ parameters.awsRegion }}
        scriptType: inline
        inlineScript: |
          Write-Host "Updating kubeconfig for EKS cluster..."
          aws eks update-kubeconfig `
            --name "${{ parameters.eksClusterName }}" `
            --region "${{ parameters.awsRegion }}"
          
          Write-Host "Current context:"
          kubectl config current-context
          
          Write-Host "Cluster nodes:"
          kubectl get nodes -o wide

    - ${{ if eq(parameters.verifyConnection, true) }}:
      - pwsh: |
          Write-Host "Verifying EKS cluster access..."
          kubectl cluster-info
          kubectl get namespaces
          Write-Host "Cluster access verified!"
        displayName: "Verify EKS cluster access"

  # ----------------------------
  # COMMON: NAMESPACE SETUP (bash)
  # ----------------------------
  - ${{ if and(ne(parameters.namespace, 'default'), eq(parameters.shellType, 'bash')) }}:
    - bash: |
        echo "Ensuring namespace '${{ parameters.namespace }}' exists..."
        kubectl get namespace ${{ parameters.namespace }} 2>/dev/null || \
          kubectl create namespace ${{ parameters.namespace }}
        
        echo "Setting default namespace to '${{ parameters.namespace }}'..."
        kubectl config set-context --current --namespace=${{ parameters.namespace }}
      displayName: "Setup namespace ${{ parameters.namespace }}"

  # ----------------------------
  # COMMON: NAMESPACE SETUP (PowerShell)
  # ----------------------------
  - ${{ if and(ne(parameters.namespace, 'default'), eq(parameters.shellType, 'pwsh')) }}:
    - pwsh: |
        Write-Host "Ensuring namespace '${{ parameters.namespace }}' exists..."
        $nsExists = kubectl get namespace ${{ parameters.namespace }} 2>$null
        if (-not $nsExists) {
            kubectl create namespace ${{ parameters.namespace }}
        }
        
        Write-Host "Setting default namespace to '${{ parameters.namespace }}'..."
        kubectl config set-context --current --namespace=${{ parameters.namespace }}
      displayName: "Setup namespace ${{ parameters.namespace }}"
